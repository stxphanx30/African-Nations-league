@model African_Nations_league.Models.TeamDetailsViewModel

@{
    ViewData["Title"] = "Team details - " + (Model.TeamName ?? "Team");
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
    :root {
        --caf-green: #126035;
        --caf-gold: #f1c232;
        --caf-red: #c8102e;
        --muted: #6c757d;
        --page-bg: #fbfcfb;
        --card-bg: #ffffff;
        --shadow: 0 10px 30px rgba(12,20,30,0.06);
        --radius: 12px;
    }

    body {
        background: var(--page-bg);
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: #222;
    }

    .team-details-container {
        max-width: 1100px;
        margin: 20px auto;
        padding: 18px;
    }

    .top-card {
        background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 2px solid rgba(200,16,46,0.06);
        overflow: hidden;
        position: relative;
    }

        .top-card .card-body {
            display: flex;
            gap: 18px;
            align-items: center;
            padding: 18px;
        }

    .team-flag-lg {
        width: 120px;
        height: 72px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.04);
    }

    .team-meta h3 {
        margin: 0;
        color: var(--caf-green);
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .team-meta small {
        color: var(--muted);
        font-weight: 600;
    }

    .team-stats {
        display: flex;
        gap: 14px;
        margin-top: 8px;
        flex-wrap: wrap;
    }

    .stat-pill {
        background: #fff;
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 700;
        border: 1px solid rgba(0,0,0,0.06);
        box-shadow: 0 6px 18px rgba(12,20,30,0.03);
        display: inline-flex;
        gap: 8px;
        align-items: center;
    }

        .stat-pill .label {
            color: var(--muted);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .stat-pill .value {
            color: #111;
            font-weight: 800;
        }

    /* Players cards grid */
    .players-grid {
        margin-top: 18px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    .player-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
        border: 2px solid rgba(200,16,46,0.04);
        box-shadow: 0 8px 24px rgba(12,20,30,0.03);
        transition: transform .12s ease, box-shadow .12s ease;
    }

        .player-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 18px 40px rgba(12,20,30,0.08);
        }

    .player-top {
        display: flex;
        gap: 12px;
        align-items: center;
        width: 100%;
    }

    .player-photo {
        width: 84px;
        height: 84px;
        border-radius: 10px;
        object-fit: cover;
        flex-shrink: 0;
        border: 1px solid rgba(0,0,0,0.04);
        box-shadow: 0 8px 20px rgba(12,20,30,0.04);
    }

    .player-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .player-name {
        font-weight: 800;
        color: var(--caf-green);
        font-size: 1.02rem;
    }

    .player-pos {
        color: var(--muted);
        font-weight: 700;
        font-size: 0.95rem;
    }

    .player-bottom {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
        justify-content: space-between;
    }

    .player-rating {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 800;
        background: linear-gradient(180deg,#fff,#fff);
        border: 1px solid rgba(0,0,0,0.06);
        min-width: 60px;
        text-align: center;
    }

    .player-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    .back-row {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px; /* slightly above the grid */
    }

    /* Morocco subtle background treatment (optional file) */
    .top-card.morocco::after {
        content: "";
        position: absolute;
        right: -30px;
        top: -20px;
        width: 160px;
        height: 160px;
        background-image: url('/images/morocco-subtle.svg');
        background-size: cover;
        opacity: 0.06;
        transform: rotate(15deg);
        pointer-events: none;
    }

    @@media (max-width: 1199.98px) {
        .players-grid

    {
        grid-template-columns: repeat(2, 1fr);
    }

    }

    @@media (max-width: 767.98px) {
        .top-card .card-body

    {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .team-flag-lg {
        width: 100%;
        height: 72px;
        max-width: 260px;
    }

    .players-grid {
        grid-template-columns: 1fr;
    }

    .player-photo {
        width: 72px;
        height: 72px;
        border-radius: 8px;
    }

    }
</style>

<div class="team-details-container">
    <div class="top-card position-relative @(string.Equals(Model.TeamName, "Morocco", System.StringComparison.OrdinalIgnoreCase) ? "morocco" : "")">
        <div class="card-body">
            @if (!string.IsNullOrEmpty(Model.TeamFlag))
            {
                <img src="@Model.TeamFlag" alt="@Model.TeamName" class="team-flag-lg" />
            }
            else
            {
                <div class="team-flag-lg" style="display:flex;align-items:center;justify-content:center;background:#f5f5f5;color:#aaa;">No flag</div>
            }

            <div class="team-meta">
                <h3>@Model.TeamName <small class="text-muted">(@Model.TeamId)</small></h3>

                <div class="team-stats">
                    @if (!string.IsNullOrEmpty(Model.ManagerName))
                    {
                        <div class="stat-pill">
                            <span class="label">Manager</span>
                            <span class="value">@Model.ManagerName</span>
                        </div>
                    }
                    <div class="stat-pill">
                        <span class="label">Rating</span>
                        <span class="value">@Model.TeamRating.ToString("F1")</span>
                    </div>
                    <div class="stat-pill">
                        <span class="label">Players</span>
                        <span class="value">@(Model.Squad?.Count ?? 0)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- boutons déplacés au-dessus de la grille -->
    <div class="back-row">
        <a asp-action="Teams" asp-controller="Teams" class="btn btn-outline-secondary">Back to teams</a>
        <a asp-action="Index" asp-controller="Home" class="btn btn-sm" style="background:var(--caf-green); color:#fff; border-radius:8px;">Home</a>
    </div>

    <h4 style="color:var(--caf-green); font-weight:800; margin-top:6px;">Players</h4>

    <div class="players-grid">
        @if (Model.Squad != null && Model.Squad.Count > 0)
        {
            foreach (var p in Model.Squad)
            {
                <div class="player-card">
                    <div class="player-top">
                        <img class="player-photo" src="@(string.IsNullOrEmpty(p.ImagePath) ? "/images/placeholder.png" : p.ImagePath)" alt="@p.PlayerName" />
                        <div class="player-meta">
                            <div class="player-name">@p.PlayerName</div>
                            <div class="player-pos">@p.Position</div>
                            <div class="player-pos" style="font-weight:600;color:var(--muted);">@p.DetailedPosition</div>
                        </div>
                    </div>

                    <div class="player-bottom">
                        <div class="player-actions">
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary view-player-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#playerModal"
                                    data-player-name="@p.PlayerName"
                                    data-player-pos="@p.Position"
                                    data-player-detailed="@p.DetailedPosition"
                                    data-player-image="@(string.IsNullOrEmpty(p.ImagePath) ? "/images/placeholder.png" : p.ImagePath)"
                                    data-player-rating="@p.Rating">
                                View
                            </button>

                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary view-player-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#playerModal"
                                    data-player-name="@p.PlayerName"
                                    data-player-pos="@p.Position"
                                    data-player-detailed="@p.DetailedPosition"
                                    data-player-image="@(string.IsNullOrEmpty(p.ImagePath) ? "/images/placeholder.png" : p.ImagePath)"
                                    data-player-rating="@p.Rating">
                                Profile
                            </button>
                        </div>

                        <div style="margin-left:auto;">
                            <div class="player-rating">@p.Rating</div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div style="grid-column:1/-1; text-align:center; color:var(--muted); padding:18px; border-radius:8px; border:1px dashed rgba(18,96,53,0.08); background:#fff;">
                No players available.
            </div>
        }
    </div>
</div>

<!-- Modal + script AJAX (Bootstrap 5) -->
<div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:1px solid rgba(0,0,0,0.06);">
                <h5 class="modal-title" id="playerModalLabel">Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="d-flex gap-3">
                    <img id="playerModalImage" src="/images/placeholder.png" alt="player" style="width:140px;height:140px;object-fit:cover;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.06)" />
                    <div style="flex:1">
                        <h5 id="playerModalName" style="color:var(--caf-green);font-weight:800;margin:0">Player name</h5>
                        <div id="playerModalPosition" class="text-muted" style="margin-top:6px">Position</div>
                        <div id="playerModalDetailed" class="text-muted" style="margin-top:6px">Detailed position</div>

                        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
                            <div style="font-weight:800;" id="playerModalRating">8.2</div>
                            <div class="text-muted" style="font-size:0.9rem;">rating</div>
                        </div>
                    </div>
                </div>

                <hr />

                <div id="playerModalExtra">
                    <p class="text-muted small">Loading extra info…</p>
                </div>
            </div>

            <div class="modal-footer" style="border-top:1px solid rgba(0,0,0,0.04);">
                <a id="playerModalProfileLink" href="#" class="btn btn-sm btn-outline-secondary" target="_blank">Full profile</a>
                <button type="button" class="btn btn-sm btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
      const playerModal = document.getElementById('playerModal');
      if (!playerModal) return;

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text ?? '';
      }

      playerModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        if (!button) return;

        const id = button.getAttribute('data-player-id') || '';
        const name = button.getAttribute('data-player-name') || '';
        const pos = button.getAttribute('data-player-pos') || '';
        const detailed = button.getAttribute('data-player-detailed') || '';
        const img = button.getAttribute('data-player-image') || '/images/placeholder.png';
        const rating = button.getAttribute('data-player-rating') || '';

        setText('playerModalLabel', name);
        setText('playerModalName', name);
        setText('playerModalPosition', pos);
        setText('playerModalDetailed', detailed);
        document.getElementById('playerModalImage').src = img;
        setText('playerModalRating', rating);

        const profileLink = document.getElementById('playerModalProfileLink');
        if (profileLink) {
          profileLink.href = id ? ('/Players/Details/' + id) : '#';
        }

        const extraContainer = document.getElementById('playerModalExtra');
        if (!extraContainer) return;
        if (!id) {
          extraContainer.innerHTML = '<p class="text-muted small">No extra info.</p>';
          return;
        }

        extraContainer.innerHTML = '<p class="text-muted small">Loading extra info…</p>';

        fetch('/Players/ExtraInfo/' + encodeURIComponent(id), {
          method: 'GET',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.text();
        })
        .then(html => {
          extraContainer.innerHTML = html || '<p class="text-muted small">No additional info.</p>';
        })
        .catch(err => {
          console.warn('Failed to load extra player info:', err);
          extraContainer.innerHTML = '<p class="text-muted small">Additional info unavailable.</p>';
        });
      });

      playerModal.addEventListener('hidden.bs.modal', function () {
        const extraContainer = document.getElementById('playerModalExtra');
        if (extraContainer) extraContainer.innerHTML = '<p class="text-muted small">No extra info.</p>';
      });
    })();
</script>