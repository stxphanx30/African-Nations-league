@model African_Nations_league.Models.BracketViewModel
@{
    ViewData["Title"] = "Bracket - Road to Final";
}
<style>
    :root {
        --caf-gold: #f3c24b;
        --caf-gold-2: #ffd97f;
        --caf-dark: #0f5a3f;
        --bg: #0e4b33;
    }

    /* layout wrapper (keeps admin menu on left) */
    .row {
        margin: 0;
    }

    .bracket-col {
        padding: 0 18px;
    }

    /* Outer */
    .bracket-wrap {
        padding: 18px;
        background: linear-gradient(180deg,#0f5a3f 0%, #0b3f2b 100%);
        border-radius: 12px;
        color: #fff;
        position: relative; /* important for svg overlay */
        overflow: visible;
    }

    /* Title */
    .road-title {
        text-align: center;
        font-weight: 900;
        font-size: 1.6rem;
        color: var(--caf-gold);
        margin-bottom: 14px;
    }

    /* Grid layout */
    .bracket-grid {
        display: grid;
        grid-template-columns: 1fr 0.95fr 260px 0.95fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 14px 18px;
        align-items: start;
        position: relative;
    }

    /* Boxes */
    .match {
        background: rgba(255,255,255,0.98);
        color: #111;
        border-radius: 10px;
        padding: 8px 12px;
        min-width: 200px;
        box-shadow: 0 8px 18px rgba(0,0,0,0.14);
        border: 1px solid rgba(0,0,0,0.06);
        position: relative;
    }

        .match.small {
            min-width: 180px;
            padding: 6px;
        }

    /* Team row */
    .team {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
    }

    .flag {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(0,0,0,0.06);
    }

    .team-name {
        font-weight: 700;
        font-size: 0.95rem;
        margin-left: 4px;
    }

    .score {
        margin-left: auto;
        font-weight: 800;
        font-size: 1rem;
    }

    /* Cup area */
    .cup {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        grid-row: 1 / span 3;
        text-align: center;
    }

        .cup img {
            width: 86px;
            display: block;
            margin-bottom: 8px;
        }

        .cup .final-title {
            font-weight: 800;
            color: var(--caf-gold);
            margin-bottom: 6px;
        }

    /* Winner highlight */
    .winner {
        background: linear-gradient(90deg,#fff9ec,#fff5d6);
        border: 1px solid #f3d48b;
    }

    /* Grid placements */
    .q0 {
        grid-column: 1;
        grid-row: 1;
    }

    .q1 {
        grid-column: 1;
        grid-row: 3;
    }

    .s0 {
        grid-column: 2;
        grid-row: 2;
        align-self: center;
    }

    .center {
        grid-column: 3;
        grid-row: 2;
    }

    .s1 {
        grid-column: 4;
        grid-row: 2;
        align-self: center;
    }

    .q2 {
        grid-column: 5;
        grid-row: 1;
    }

    .q3 {
        grid-column: 5;
        grid-row: 3;
    }

    /* final card same visual */
    .final-card.match {
        width: 240px;
    }

    /* small helper text */
    .small-muted {
        color: rgba(255,255,255,0.85);
        font-size: 0.9rem;
        text-align: center;
        margin-top: 10px;
    }

    /* responsive */
    @@media (max-width:1100px) {
        .bracket-grid

    {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .q0, .q1, .s0, .center, .s1, .q2, .q3 {
        grid-column: 1;
        grid-row: auto;
    }

    .cup img {
        width: 72px;
    }
    /* optionally hide connectors via JS/CSS if desired */
    }</style>
   <div class="container bracket-wrap mt-4" id="bracketWrap">
            <div class="road-title">ROAD TO FINAL</div>

            <!-- SVG overlay (positioned absolute inside .bracket-wrap) -->
            <svg id="connectorsSvg" style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:5;" preserveAspectRatio="none"></svg>

            <div class="bracket-grid" id="bracketGrid">
                <!-- q0 -->
                <div class="q0" id="q0">
                    <div style="text-align:center;font-weight:700;margin-bottom:8px;color:var(--caf-gold)">Quarts (Left Top)</div>
                    @{
                        var m = Model.QuarterMatches?.ElementAtOrDefault(0);
                    }
                    @if (m != null)
                    {
                        var wA = (m.ScoreA > m.ScoreB) && (m.Status == "Finished" || m.Status == "Played");
                        var wB = (m.ScoreB > m.ScoreA) && (m.Status == "Finished" || m.Status == "Played");
                        <div class="match @(wA ? "winner" : wB ? "winner" : "")" id="match-q0">
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m.TeamAFlag))
                                {
                                    <img src="@m.TeamAFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m.TeamAName) ? m.TeamAName : "Team A waiting")</div>
                                <div class="score">@m.ScoreA</div>
                            </div>
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m.TeamBFlag))
                                {
                                    <img src="@m.TeamBFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m.TeamBName) ? m.TeamBName : "Team B waiting")</div>
                                <div class="score">@m.ScoreB</div>
                            </div>
                        </div>
                    }
                    else
                    {

                        <div class="match small">Waiting for match</div>
                    }
                </div>

                <!-- s0 -->
                <div class="s0" id="s0">
                    <div style="text-align:center;font-weight:700;margin-bottom:8px;color:var(--caf-gold)">Demi (Left)</div>
                    @{
                        var sm0 = Model.SemiMatches?.ElementAtOrDefault(0);
                    }
                    @if (sm0 != null)
                    {
                        var wA = (sm0.ScoreA > sm0.ScoreB) && (sm0.Status == "Finished" || sm0.Status == "Played");
                        var wB = (sm0.ScoreB > sm0.ScoreA) && (sm0.Status == "Finished" || sm0.Status == "Played");
                        <div class="match @(wA ? "winner" : wB ? "winner" : "")" id="match-s0" style="width:240px;">
                            <div class="team">
                                @if (!string.IsNullOrEmpty(sm0.TeamAFlag))
                                {
                                    <img src="@sm0.TeamAFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(sm0.TeamAName) ? sm0.TeamAName : "Waiting")</div>
                                <div class="score">@sm0.ScoreA</div>
                            </div>
                            <div class="team">
                                @if (!string.IsNullOrEmpty(sm0.TeamBFlag))
                                {
                                    <img src="@sm0.TeamBFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(sm0.TeamBName) ? sm0.TeamBName : "Waiting")</div>
                                <div class="score">@sm0.ScoreB</div>
                            </div>
                        </div>
                    }
                    else
                    {

                        <div class="match small" id="match-s0">Waiting for semi</div>
                    }
                </div>

                <!-- center cup/final -->
                <div class="center cup" id="center">
                    <img src="/Images/cup.png" alt="cup" onerror="this.src='/Images/solid_color_003366_dark_blue_background_template_square_sticker-r286e768c2b804342bb4172e8c2653c26_v9wf3_8byvr_307.png'" />
                    <div class="final-title">FINALE</div>

                    @if (Model.FinalMatch != null)
                    {
                        var fm = Model.FinalMatch;
                        <div class="match final-card" id="match-final" style="margin-top:8px;width:240px;">
                            <div class="team">
                                @if (!string.IsNullOrEmpty(fm.TeamAFlag))
                                {
                                    <img src="@fm.TeamAFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(fm.TeamAName) ? fm.TeamAName : "Waiting")</div>
                                <div class="score">@fm.ScoreA</div>
                            </div>
                            <div class="team">
                                @if (!string.IsNullOrEmpty(fm.TeamBFlag))
                                {
                                    <img src="@fm.TeamBFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(fm.TeamBName) ? fm.TeamBName : "Waiting")</div>
                                <div class="score">@fm.ScoreB</div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.Champion))
                        {
                            <div style="margin-top:8px;font-weight:800;color:var(--caf-gold)">Champion: @Model.Champion</div>
                        }
                    }
                    else
                    {
                        <div class="small-muted">Finale non générée</div>
                    }
                </div>

                <!-- s1 -->
                <div class="s1" id="s1">
                    <div style="text-align:center;font-weight:700;margin-bottom:8px;color:var(--caf-gold)">Demi (Right)</div>
                    @{
                        var sm1 = Model.SemiMatches?.ElementAtOrDefault(1);
                    }
                    @if (sm1 != null)
                    {
                        var wA = (sm1.ScoreA > sm1.ScoreB) && (sm1.Status == "Finished" || sm1.Status == "Played");
                        var wB = (sm1.ScoreB > sm1.ScoreA) && (sm1.Status == "Finished" || sm1.Status == "Played");
                        <div class="match @(wA ? "winner" : wB ? "winner" : "")" id="match-s1" style="width:240px;">
                            <div class="team">
                                @if (!string.IsNullOrEmpty(sm1.TeamAFlag))
                                {
                                    <img src="@sm1.TeamAFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(sm1.TeamAName) ? sm1.TeamAName : "Waiting")</div>
                                <div class="score">@sm1.ScoreA</div>
                            </div>
                            <div class="team">
                                @if (!string.IsNullOrEmpty(sm1.TeamBFlag))
                                {
                                    <img src="@sm1.TeamBFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(sm1.TeamBName) ? sm1.TeamBName : "Waiting")</div>
                                <div class="score">@sm1.ScoreB</div>
                            </div>
                        </div>
                    }
                    else
                    {

                        <div class="match small" id="match-s1">Waiting for semi</div>
                    }
                </div>

                <!-- q2 -->
                <div class="q2" id="q2">
                    <div style="text-align:center;font-weight:700;margin-bottom:8px;color:var(--caf-gold)">Quarts (Right Top)</div>
                    @{
                        var m2 = Model.QuarterMatches?.ElementAtOrDefault(2);
                    }
                    @if (m2 != null)
                    {
                        var wA = (m2.ScoreA > m2.ScoreB) && (m2.Status == "Finished" || m2.Status == "Played");
                        var wB = (m2.ScoreB > m2.ScoreA) && (m2.Status == "Finished" || m2.Status == "Played");
                        <div class="match @(wA ? "winner" : wB ? "winner" : "")" id="match-q2">
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m2.TeamAFlag))
                                {
                                    <img src="@m2.TeamAFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m2.TeamAName) ? m2.TeamAName : "Team A waiting")</div>
                                <div class="score">@m2.ScoreA</div>
                            </div>
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m2.TeamBFlag))
                                {
                                    <img src="@m2.TeamBFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m2.TeamBName) ? m2.TeamBName : "Team B waiting")</div>
                                <div class="score">@m2.ScoreB</div>
                            </div>
                        </div>
                    }
                    else
                    {

                        <div class="match small">Waiting for match</div>
                    }
                </div>

                <!-- q1 (left bottom) -->
                <div class="q1" id="q1">
                    <div style="text-align:center;font-weight:700;margin-bottom:8px;color:var(--caf-gold)">Quarts (Left Bottom)</div>
                    @{
                        var m1 = Model.QuarterMatches?.ElementAtOrDefault(1);
                    }
                    @if (m1 != null)
                    {
                        var wA = (m1.ScoreA > m1.ScoreB) && (m1.Status == "Finished" || m1.Status == "Played");
                        var wB = (m1.ScoreB > m1.ScoreA) && (m1.Status == "Finished" || m1.Status == "Played");
                        <div class="match @(wA ? "winner" : wB ? "winner" : "")" id="match-q1">
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m1.TeamAFlag))
                                {
                                    <img src="@m1.TeamAFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m1.TeamAName) ? m1.TeamAName : "Team A waiting")</div>
                                <div class="score">@m1.ScoreA</div>
                            </div>
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m1.TeamBFlag))
                                {
                                    <img src="@m1.TeamBFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m1.TeamBName) ? m1.TeamBName : "Team B waiting")</div>
                                <div class="score">@m1.ScoreB</div>
                            </div>
                        </div>
                    }
                    else
                    {

                        <div class="match small">Waiting for match</div>
                    }
                </div>

                <!-- q3 -->
                <div class="q3" id="q3">
                    <div style="text-align:center;font-weight:700;margin-bottom:8px;color:var(--caf-gold)">Quarts (Right Bottom)</div>
                    @{
                        var m3 = Model.QuarterMatches?.ElementAtOrDefault(3);
                    }
                    @if (m3 != null)
                    {
                        var wA = (m3.ScoreA > m3.ScoreB) && (m3.Status == "Finished" || m3.Status == "Played");
                        var wB = (m3.ScoreB > m3.ScoreA) && (m3.Status == "Finished" || m3.Status == "Played");
                        <div class="match @(wA ? "winner" : wB ? "winner" : "")" id="match-q3">
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m3.TeamAFlag))
                                {
                                    <img src="@m3.TeamAFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m3.TeamAName) ? m3.TeamAName : "Team A waiting")</div>
                                <div class="score">@m3.ScoreA</div>
                            </div>
                            <div class="team">
                                @if (!string.IsNullOrEmpty(m3.TeamBFlag))
                                {
                                    <img src="@m3.TeamBFlag" class="flag" />
                                }
                                <div class="team-name">@(!string.IsNullOrEmpty(m3.TeamBName) ? m3.TeamBName : "Team B waiting")</div>
                                <div class="score">@m3.ScoreB</div>
                            </div>
                        </div>
                    }
                    else
                    {

                        <div class="match small">Waiting for match</div>
                    }
                </div>

            </div>

            <div style="text-align:center;margin-top:14px;color:rgba(255,255,255,0.85)">
                <small>Les lignes connectent automatiquement les matchs (responsive). Si un drapeau n'apparaît pas, vérifie TeamAFlag/TeamBFlag dans la fixture.</small>
            </div>
        </div>
 

<script>
    (function(){
        const svg = document.getElementById('connectorsSvg');
        const wrap = document.getElementById('bracketWrap');

        function makePath(d){
            const p = document.createElementNS('http://www.w3.org/2000/svg','path');
            p.setAttribute('d', d);
            p.setAttribute('fill','none');
            p.setAttribute('stroke','url(#goldGrad)');
            p.setAttribute('stroke-width','6');
            p.setAttribute('stroke-linecap','round');
            p.setAttribute('stroke-linejoin','round');
            p.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))';
            return p;
        }

        function ensureGradient(){
            if (svg.querySelector('#goldGrad')) return;
            const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
            const grad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
            grad.setAttribute('id','goldGrad');
            grad.setAttribute('x1','0%'); grad.setAttribute('x2','100%');
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg','stop'); stop1.setAttribute('offset','0%'); stop1.setAttribute('stop-color','#f3c24b');
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg','stop'); stop2.setAttribute('offset','100%'); stop2.setAttribute('stop-color','#ffd97f');
            grad.appendChild(stop1); grad.appendChild(stop2);
            defs.appendChild(grad);
            svg.appendChild(defs);
        }

        function centerRelativeToWrap(el){
            const elRect = el.getBoundingClientRect();
            const wrapRect = wrap.getBoundingClientRect();
            return {
                x: (elRect.left - wrapRect.left) + elRect.width/2,
                y: (elRect.top - wrapRect.top) + elRect.height/2,
                rect: elRect
            };
        }

        const connections = [
            { from: 'match-q0', to: 'match-s0' },
            { from: 'match-q1', to: 'match-s0' },
            { from: 'match-q2', to: 'match-s1' },
            { from: 'match-q3', to: 'match-s1' },
            { from: 'match-s0', to: 'match-final' },
            { from: 'match-s1', to: 'match-final' }
        ];

        function clearSvg(){
            while(svg.firstChild) svg.removeChild(svg.firstChild);
        }

        function drawAll(){
            ensureGradient();

            // keep defs if present
            let existingDefs = null;
            const d = svg.querySelector('defs');
            if (d) { existingDefs = d.cloneNode(true); }

            clearSvg();
            if (existingDefs) svg.appendChild(existingDefs);

            // size svg to wrap
            const wrapRect = wrap.getBoundingClientRect();
            const width = Math.max(100, wrapRect.width);
            const height = Math.max(100, wrapRect.height);
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', 0 0 ${width} ${height});
            svg.style.left = '0px';
            svg.style.top = '0px';

            connections.forEach(conn => {
                const fromEl = document.getElementById(conn.from);
                const toEl = document.getElementById(conn.to);
                if (!fromEl || !toEl) return;

                const a = centerRelativeToWrap(fromEl);
                const b = centerRelativeToWrap(toEl);

                // control points for smooth curve
                const dx = Math.abs(b.x - a.x);
                const cpOffset = Math.max(40, dx * 0.28);
                const cp1x = a.x + (b.x > a.x ? cpOffset : -cpOffset);
                const cp1y = a.y;
                const cp2x = b.x - (b.x > a.x ? cpOffset : -cpOffset);
                const cp2y = b.y;

                const pathD = M ${a.x} ${a.y} C ${cp1x} ${cp1y} ${cp2x} ${cp2y} ${b.x} ${b.y};
                const path = makePath(pathD);
                svg.appendChild(path);
            });
        }

        // debounce
        function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); } }
        const doDraw = debounce(()=>{ try { drawAll(); } catch(e) { console.warn(e); } }, 70);

        document.addEventListener('DOMContentLoaded', doDraw);
        window.addEventListener('load', doDraw);
        window.addEventListener('resize', doDraw);
        window.addEventListener('orientationchange', doDraw);

        // images can load late -> redraw
        setTimeout(doDraw, 300);
        setTimeout(doDraw, 900);
    })();
</script>